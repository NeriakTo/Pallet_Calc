<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8">
    <title>棧板堆疊計算器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body { font-family: "Noto Sans TC", sans-serif; margin: 0; padding: 0; background: #f7f7f7; }
      header { background: #2b4b80; color: #fff; padding: 1.5rem 2rem; }
      main { max-width: 960px; margin: 0 auto; padding: 2rem; }
      h1 { margin: 0; font-size: 1.8rem; }
      form { background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
      fieldset { border: none; margin: 0 0 1.5rem 0; padding: 0; }
      legend { font-weight: 600; margin-bottom: 0.5rem; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
      label { display: block; font-size: 0.9rem; margin-bottom: 0.25rem; }
      input, select { width: 100%; padding: 0.45rem 0.6rem; border: 1px solid #ccd2da; border-radius: 4px; }
      button { background: #2b4b80; color: #fff; border: none; padding: 0.65rem 1.5rem; border-radius: 4px; cursor: pointer; font-size: 1rem; }
      button:hover { background: #1f3a63; }
      .message { margin-top: 1.5rem; padding: 1rem 1.2rem; border-radius: 6px; }
      .message.error { background: #ffe5e5; color: #7d1d1d; border: 1px solid #f0b5b5; }
      .results { margin-top: 2rem; }
      table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
      th, td { padding: 0.75rem; border-bottom: 1px solid #e5e8ee; text-align: left; }
      th { background: #f1f4f9; font-weight: 600; }
      tr:last-child td { border-bottom: none; }
      .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
      .card { background: #fff; border-radius: 8px; padding: 1rem 1.2rem; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
      .card h3 { margin: 0 0 0.5rem 0; font-size: 1rem; color: #2b4b80; }
      .card p { margin: 0.25rem 0; }
    </style>
  </head>
  <body>
    <header>
      <h1>棧板堆疊計算器</h1>
      <p>輸入產品與棧板資訊，即可計算所需棧板與材積。</p>
    </header>
    <main>
      <form method="post">
        <fieldset>
          <legend>產品資訊</legend>
          <div class="grid">
            <div>
              <label for="product_name">產品名稱</label>
              <input type="text" id="product_name" name="product_name" value="{{ form.product_name }}">
            </div>
            <div>
              <label for="order_quantity_pcs">訂單總數 (pcs)</label>
              <input type="number" id="order_quantity_pcs" name="order_quantity_pcs" min="1" required value="{{ form.order_quantity_pcs }}">
            </div>
            <div>
              <label for="pcs_per_carton">每箱入數 (pcs)</label>
              <input type="number" id="pcs_per_carton" name="pcs_per_carton" min="1" required value="{{ form.pcs_per_carton }}">
            </div>
            <div>
              <label for="carton_length_cm">外箱長度 (cm)</label>
              <input type="number" step="0.01" min="0" id="carton_length_cm" name="carton_length_cm" required value="{{ form.carton_length_cm }}">
            </div>
            <div>
              <label for="carton_width_cm">外箱寬度 (cm)</label>
              <input type="number" step="0.01" min="0" id="carton_width_cm" name="carton_width_cm" required value="{{ form.carton_width_cm }}">
            </div>
            <div>
              <label for="carton_height_cm">外箱高度 (cm)</label>
              <input type="number" step="0.01" min="0" id="carton_height_cm" name="carton_height_cm" required value="{{ form.carton_height_cm }}">
            </div>
          </div>
        </fieldset>
        <fieldset>
          <legend>棧板資訊</legend>
          <div class="grid">
            <div>
              <label for="pallet_length_cm">棧板長度 (cm)</label>
              <input type="number" step="0.01" min="0" id="pallet_length_cm" name="pallet_length_cm" required value="{{ form.pallet_length_cm }}">
            </div>
            <div>
              <label for="pallet_width_cm">棧板寬度 (cm)</label>
              <input type="number" step="0.01" min="0" id="pallet_width_cm" name="pallet_width_cm" required value="{{ form.pallet_width_cm }}">
            </div>
            <div>
              <label for="pallet_height_cm">棧板總高度限制 (cm)</label>
              <input type="number" step="0.01" min="0" id="pallet_height_cm" name="pallet_height_cm" required value="{{ form.pallet_height_cm }}">
            </div>
            <div>
              <label for="container_height">裝櫃高度限制</label>
              <select id="container_height" name="container_height">
                {% for value, label in container_options %}
                <option value="{{ value }}" {% if form.container_height == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label for="allow_mixed_remainders">餘數混裝堆疊</label>
              <select id="allow_mixed_remainders" name="allow_mixed_remainders">
                <option value="Yes" {% if form.allow_mixed_remainders|lower == 'yes' %}selected{% endif %}>Yes</option>
                <option value="No" {% if form.allow_mixed_remainders|lower == 'no' %}selected{% endif %}>No</option>
              </select>
            </div>
          </div>
        </fieldset>
        <button type="submit">計算</button>
      </form>

      {% if error %}
      <div class="message error">{{ error }}</div>
      {% endif %}

      {% if result %}
      <section class="results">
        <div class="summary-cards">
          <div class="card">
            <h3>總箱數</h3>
            <p>{{ result.total_cartons }}</p>
          </div>
          <div class="card">
            <h3>所需棧板數</h3>
            <p>{{ result.total_pallets }}</p>
          </div>
          <div class="card">
            <h3>材積 (不含棧板)</h3>
            <p>{{ '%.3f'|format(result.volume_without_pallets_cbm) }} CBM<br>{{ '%.1f'|format(result.volume_without_pallets_cuft) }} CUFT</p>
          </div>
          <div class="card">
            <h3>材積 (含棧板)</h3>
            <p>{{ '%.3f'|format(result.volume_with_pallets_cbm) }} CBM<br>{{ '%.1f'|format(result.volume_with_pallets_cuft) }} CUFT</p>
          </div>
        </div>

        <h2>產品配置</h2>
        <table>
          <thead>
            <tr>
              <th>產品</th>
              <th>單層箱數</th>
              <th>長向箱數</th>
              <th>寬向箱數</th>
              <th>每棧板層數</th>
              <th>每棧板箱數</th>
              <th>完整棧板</th>
              <th>餘數箱數</th>
            </tr>
          </thead>
          <tbody>
            {% for plan in result.product_plans %}
            <tr>
              <td>{{ plan.product }}</td>
              <td>{{ plan.orientation.cartons_per_layer }}</td>
              <td>{{ plan.orientation.cartons_along_length }}</td>
              <td>{{ plan.orientation.cartons_along_width }}</td>
              <td>{{ plan.layers_per_pallet }}</td>
              <td>{{ plan.cartons_per_pallet }}</td>
              <td>{{ plan.full_pallets }}</td>
              <td>{{ plan.remainder_cartons }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        {% if result.pallets %}
        <h2>棧板明細</h2>
        <table>
          <thead>
            <tr>
              <th>棧板</th>
              <th>數量</th>
              <th>各產品箱數</th>
              <th>貨物高度 (cm)</th>
              <th>總高度 (含棧板) (cm)</th>
            </tr>
          </thead>
          <tbody>
            {% for pallet in result.pallets %}
            <tr>
              <td>{{ pallet.label }}</td>
              <td>{{ pallet.count }}</td>
              <td>
                {% for product, count in pallet.cartons_by_product.items() %}
                  <div>{{ product }}：{{ count }}</div>
                {% endfor %}
              </td>
              <td>{{ '%.1f'|format(pallet.goods_height_cm) }}</td>
              <td>{{ '%.1f'|format(pallet.total_height_cm) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}
      </section>
      {% endif %}
    </main>
  </body>
</html>
